rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================================================
    // HELPER FUNCTIONS - Using Custom Claims (Secure)
    // ===================================================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Get user ID from auth context
    function getUserId() {
      return request.auth.uid;
    }
    
    // Check if user is admin via CUSTOM CLAIMS (not Firestore)
    // This is SECURE because custom claims are in the JWT token
    function isAdmin() {
      return isSignedIn() && 
             (request.auth.token.admin == true || 
              request.auth.token.superAdmin == true);
    }
    
    // Check if user is super admin via CUSTOM CLAIMS
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.superAdmin == true;
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isSignedIn() && getUserId() == userId;
    }
    
    // ===================================================================
    // USERS COLLECTION
    // ===================================================================
    match /users/{userId} {
      // Read: Users can read their own document, admins can read any
      allow read: if isOwner(userId) || isAdmin();
      
      // Create: Users can create their own document BUT cannot set role fields
      allow create: if isOwner(userId) && 
                       !request.resource.data.keys().hasAny([
                         'role', 'isAdmin', 'isSuperAdmin', 
                         'lastRoleUpdate', 'updatedBy'
                       ]);
      
      // Update: Users can update their own document BUT cannot modify role fields
      allow update: if isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['role', 'isAdmin', 'isSuperAdmin', 
                                  'lastRoleUpdate', 'updatedBy']);
      
      // Delete: Only admins can delete users
      allow delete: if isAdmin();
      
      // Shops subcollection
      match /shops/{shopId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
    }
    
    // ===================================================================
    // SHOPIFY STATES (OAuth Flow)
    // ===================================================================
    match /shopify_states/{stateId} {
      allow read, write: if isSignedIn();
    }
    
    // ===================================================================
    // SHOPS COLLECTION (if you have a top-level shops collection)
    // ===================================================================
    match /shops/{shopId} {
      allow read: if isSignedIn() && 
                     (resource.data.userId == getUserId() || isAdmin());
      allow create: if isSignedIn();
      allow update: if isSignedIn() && 
                       (resource.data.userId == getUserId() || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ===================================================================
    // ONBOARDING APPLICATIONS COLLECTION
    // SECURITY: Each user can ONLY access their own onboarding application
    // ===================================================================
    match /onboarding_applications/{userId} {
      // CRITICAL: Document ID MUST match user's UID
      // This ensures row-level security - no user can see other users' data
      
      // Read: Users can ONLY read their own application, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Create: Users can ONLY create their own application
      // SECURITY: Cannot create application for another user
      allow create: if isOwner(userId) && 
                       request.resource.data.userId == getUserId();
      
      // Update: Users can ONLY update their own application
      // SECURITY: Cannot change userId or hijack another user's application
      // Users can set status to 'draft', 'pending_review', or 'approved' (auto-approval)
      // SECURITY: Users cannot set reviewedBy field (reserved for admin reviews)
      allow update: if isOwner(userId) && 
                       request.resource.data.userId == getUserId() &&
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['userId', 'reviewedBy']) &&
                       // Users can set status to 'draft', 'pending_review', or 'approved'
                       (request.resource.data.status == 'draft' || 
                        request.resource.data.status == 'pending_review' ||
                        request.resource.data.status == 'approved');
      
      // Delete: Only admins can delete applications
      allow delete: if isAdmin();
    }
    
    // ===================================================================
    // ORDERS COLLECTION
    // ===================================================================
    match /orders/{orderId} {
      allow read: if isSignedIn() && isAdmin();
      allow create: if false; // Only via backend
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ===================================================================
    // INVOICES COLLECTION
    // ===================================================================
    match /invoices/{invoiceId} {
      allow read: if isSignedIn() && 
                     (resource.data.userId == getUserId() || isAdmin());
      allow write: if false; // Only via backend
    }
    
    // ===================================================================
    // AFFILIATE STATS COLLECTION
    // ===================================================================
    match /affiliate_stats/{statId} {
      allow read: if isSignedIn() && 
                     (resource.data.userId == getUserId() || isAdmin());
      allow write: if false; // Only via backend
    }
    
    // ===================================================================
    // ADMIN LOGS COLLECTION
    // ===================================================================
    match /admin_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only via backend
    }
    
    // ===================================================================
    // DEFAULT DENY - Important for security!
    // ===================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}